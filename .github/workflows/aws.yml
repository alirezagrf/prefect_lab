name: Deploy to Cloud

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

env:
  PREFECT_API_KEY : ${{ secrets.PREFECT_API_KEY }}
  PREFECT_API_URL : ${{ secrets.PREFECT_API_URL }}
  
permissions:
  contents: read

jobs:
  test-flow-load:
    name: Build and apply deployment
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v3
      
    - name: Setup Python
      uses: actions/setup-python@v4.4.0
      with:
        python-version: "3.10"
        cache: "pip"
        cache-dependency-path: "requirements.txt"
    
    - name: Install packages
      run: |
        python -m pip install --upgrade pip
        pip install --upgrade --upgrade-strategy eager -r requirements.txt

    - name: Build and apply deployment
      run: |
        prefect deployment build ./aws_flow.py:basic_flow \
        --name "Demo aws flow" \
        -sb github/github \
        -q githubwq \
        -v $GITHUB_SHA \
        --apply
